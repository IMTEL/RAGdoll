version: "3.9"

services:
  # Reverse proxy handling HTTPS with NTNU cert
  nginx:
    image: nginx:stable
    container_name: ragdoll-nginx
    depends_on:
      - chat-service
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Mount static config and SSL certs
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - /root/iplvr.it.ntnu.no.crt:/etc/ssl/certs/server.crt:ro
      - /root/iplvr.it.ntnu.no.key:/etc/ssl/private/server.key:ro
    restart: unless-stopped

  # FastAPI backend
  chat-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ragdoll-backend
    expose:
      - "8000"  # internal only, Nginx connects here
    environment:
      - ENV=prod
      - MONGODB_URI=mongodb://mongodb:27017
      - MONGODB_DATABASE=${MONGODB_DATABASE}
      - MONGODB_CONTEXT_COLLECTION=${MONGODB_CONTEXT_COLLECTION}
      - MONGODB_AGENT_COLLECTION=${MONGODB_AGENT_COLLECTION}
      - RAG_DATABASE_SYSTEM=mongodb
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped

  # MongoDB (internal only)
  mongodb:
    image: mongo:latest
    container_name: mongodb
    volumes:
      - mongo-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

volumes:
  mongo-data: {}
